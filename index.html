<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Dockerfile</title>
    <script src="https://cdn.jsdelivr.net/npm/@ryangjchandler/alpine-clipboard@0.1.x/dist/alpine-clipboard.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

    <script src="index.js"></script>

    <script>
      function onlySelected(opts) {
        return Object.entries(opts).filter(([k, checked]) => checked).map(([k, f]) => k)
      }

      function fromUrl() {
        let params = new URLSearchParams(location.search)
        let parts = (params.get('selected') || "").split(",")
        let selection = Object.keys(builtinOptions).reduce((acc, val) => {
          acc[val] = parts.includes(val)
          return acc
        }, {})
        return selection
      }

      function model() {
        return {
          selected: fromUrl(),
          searchTerm: '',
          visibleOptions() {
            let visible = Object.entries(builtinOptions).filter(([name, f]) => name.includes(this.searchTerm))
            return Object.fromEntries(visible)
          },
          dockerfile() {
            return toDockerfile(ubuntu1804, onlySelected(this.selected))
          },
          updateUrl() {
            const picked = onlySelected(this.selected)

            const url = new URL(window.location.href);
            if (picked.length) {
              url.searchParams.set('selected', picked.join(','));
            } else {
              url.searchParams.delete('selected');
            }
            history.pushState(null, document.title, url.toString());
          }
        }
      }
    </script>
  </head>

  <body class="bg-grey-light leading-normal tracking-normal">
    <main  class="max-w-prose mx-auto">
      <h1 class="text-4xl font-normal tracking-wide my-12">Generate a quick Dockerfile</h1>

      <div x-data="model()" >
        <input type="text" x-model="searchTerm" placeholder="Filter here..." class="input border border-gray-400 appearance-none rounded w-full px-3 py-3 pt-2 pb-2 focus focus:border-blue-600 focus:outline-none active:outline-none active:border-blue-600" >
        <ul class="my-4 grid grid-cols-3 gap-4">
          <template x-for="(choice, index) in Object.keys(visibleOptions())" :key="index">
            <div class="flex flex-row">
              <input class="self-center" type="checkbox" :id="choice" x-model="selected[choice]" @change="updateUrl()"></input>
              <label class="self-center ml-2" :for="choice" x-text="choice"></label>
            </div>
          </template>
        </ul>

        <code class="bg-gray-100 p-4 rounded border border-gray-300 overflow-x-auto text-xs font-mono flex flex-col">
          <template x-for="line in dockerfile()">
            <span class="whitespace-pre" x-text="line"></span>
          </template>
        </code>

        <button @click="$clipboard(dockerfile().join('\n'))" class="my-4 uppercase px-8 py-2 rounded border border-blue-600 text-blue-600 max-w-max shadow-sm hover:shadow-md">Copy ðŸ“‹</button>
      </div>
    </main>
  </body>
</html>
