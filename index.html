<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Dockerfile</title>
    <script src="https://cdn.jsdelivr.net/npm/@ryangjchandler/alpine-clipboard@0.1.x/dist/alpine-clipboard.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
    <link rel="stylesheet" href="/app.css">

    <script src="index.js"></script>

    <script>
      function onlySelected(opts) {
        return Object.entries(opts).filter(([k, checked]) => checked).map(([k, f]) => k)
      }

      function fromUrl() {
        let params = new URLSearchParams(location.search)
        let parts = (params.get('selected') || "").split(",")
        let selection = Object.keys(builtinOptions).reduce((acc, val) => {
          acc[val] = parts.includes(val)
          return acc
        }, {})
        return selection
      }

      function model() {
        return {
          selected: fromUrl(),
          searchTerm: '',
          visibleOptions() {
            let visible = Object.entries(builtinOptions).filter(([name, f]) => name.includes(this.searchTerm))
            return Object.fromEntries(visible)
          },
          dockerfile() {
            return toDockerfile(ubuntu1804, onlySelected(this.selected))
          },
          updateUrl() {
            const picked = onlySelected(this.selected)

            const url = new URL(window.location.href);
            if (picked.length) {
              url.searchParams.set('selected', picked.join(','));
            } else {
              url.searchParams.delete('selected');
            }
            history.pushState(null, document.title, url.toString());
          }
        }
      }
    </script>
  </head>
  <body>
    <h1>Generate a quick Dockerfile</h1>
    <div x-data="model()" >
      <input type="text" x-model="searchTerm" placeholder="Filter here...">
      <ul>
        <template x-for="(choice, index) in Object.keys(visibleOptions())" :key="index">
          <div>
            <input type="checkbox" :id="choice" x-model="selected[choice]" @change="updateUrl()"></input>
            <label :for="choice" x-text="choice"></label>
          </div>
        </template>
      </ul>
      <code>
        <template x-for="line in dockerfile()">
          <span style="white-space: pre;" x-text="line"></span>
        </template>
      </code>

      <button @click="$clipboard(dockerfile().join('\n'))">Copy</button>
    </div>
  </body>
</html>
